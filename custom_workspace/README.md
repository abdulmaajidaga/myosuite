# Custom Workspace for MyoSuite

This workspace contains custom scripts and tools for processing kinematic data (Inverse Kinematics) and training Reinforcement Learning (RL) agents within the MyoSuite environment.

## Directory Structure

```
custom_workspace/
├── alignment.json          # Configuration for coordinate alignment
├── data/                   # Input data (Kinematics, etc.)
│   └── kinematic/          # CSV files from motion capture (e.g., Stroke patients)
├── IK/                     # Inverse Kinematics Pipeline
│   ├── run.py              # MASTER SCRIPT: Main entry point for the pipeline
│   ├── run_modular.py      # Modularized version of the IK pipeline
│   ├── batch_processor.py  # Logic for batch processing multiple files
│   ├── convert_*.py        # Individual conversion scripts (CSV->TRC->MOT->Video)
│   ├── modular/            # Helper Python package for IK operations
│   └── output/             # Generated files (.trc, .mot, .mp4)
├── model/                  # Simulation models (MJCF/XML)
└── RL/                     # Reinforcement Learning experiments
    └── train_drinking_task.py  # PPO training with imitation learning
```

## Inverse Kinematics (IK) Pipeline

The IK pipeline converts raw motion capture data (CSV) into OpenSim/Mujoco compatible motion files (.mot) and renders videos.

### IK Scripts Description

The `IK/` directory contains several scripts for processing kinematic data, scaling models, and analyzing motions:

*   **`run.py`**: The main entry point. It orchestrates the full pipeline: CSV -> TRC -> MOT -> MP4. It can run in single-file mode or batch mode.
*   **`run_modular.py`**: A refactored, modular version of the IK pipeline that uses the `modular/` sub-package for cleaner logic separation.
*   **`batch_processor.py`**: Contains the logic used by `run.py` to iterate through multiple files, ensuring specific reference files are processed first.
*   **`convert_csv2trc.py`**: Converts raw motion capture CSV data (with multi-level headers) into OpenSim-compatible TRC marker files.
*   **`convert_trc2mot.py`**: The core IK solver. It uses MuJoCo to find joint angles that best match the marker positions in the TRC file, producing a MOT file.
*   **`convert_mot2video.py`**: Loads a MOT file and a MuJoCo model, then renders the motion to an MP4 video file.
*   **`auto_scaler.py`**: Calculates subject-specific limb lengths from TRC data and automatically scales the MuJoCo model's bodies (humerus, ulna, etc.) to match the subject.
*   **`trc_data_scaler.py`**: Scales the TRC marker data itself to match the dimensions of a specific MuJoCo model, useful for retargeting.
*   **`calc_mot2invdyn.py`**: Performs Inverse Dynamics. It calculates the forces/torques required to produce the motion described in a MOT file.
*   **`interactive_alignment.py`**: Provides a GUI (using MuJoCo viewer) to manually align the motion capture coordinate system with the MuJoCo model's frame.
*   **`train_motion_model.py`**: Trains a statistical model (using PCA and Support Vector Regression) to generate new motions based on clinical scores (like FMA-UE).
*   **`visualise_model.py`**: Visualizes the results of the motion model training, showing the PCA latent space and the regression paths between different clinical states.

### How to Use the IK Pipeline

```bash
cd custom_workspace/IK
python run.py
```

### Configuration (`IK/run.py`)

You can configure the pipeline by editing `IK/run.py`:

*   **`RUN_BATCH_MODE`**:
    *   `True`: Processes **all** CSV files in `data/kinematic/Stroke`.
    *   `False`: Processes a **single** file (defined by `SINGLE_INPUT_CSV`).
*   **`REF_FILE`**: `S5_12_1.csv` is often treated as a reference file and processed first in batch mode.

### Pipeline Steps

1.  **CSV to TRC** (`convert_csv2trc.py`): Converts raw marker data to TRC format.
2.  **TRC to MOT** (`convert_trc2mot.py`): Solves Inverse Kinematics to generate joint angles (.mot).
3.  **MOT to Video** (`convert_mot2video.py`): Renders the motion in the Mujoco simulation.

### Modular Pipeline

`IK/run_modular.py` is a refactored version of the pipeline that uses the `modular/` package for cleaner code organization. It performs similar steps but is structured for better maintainability.

## Reinforcement Learning (RL)

The `RL` directory contains scripts for training agents to perform tasks.

### Training (`RL/train_drinking_task.py`)

This script trains a PPO agent (using Stable Baselines 3) to perform a drinking task. It uses **Imitation Learning** by rewarding the agent for tracking a reference motion (.mot file).

**Usage:**

```bash
cd custom_workspace/RL
python train_drinking_task.py
```

*   **Input**: Requires a valid `.mot` file (generated by the IK pipeline) to use as a reference.
*   **Environment**: Uses `myo_sim` environments (e.g., `RelocateEnvV0`).

## Alignment

`alignment.json` contains manual offsets (x, y, z) and rotations (r, p, yw) used to align the motion capture data with the MyoSuite model frame.
